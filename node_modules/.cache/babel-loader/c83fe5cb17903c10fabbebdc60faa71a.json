{"ast":null,"code":"import { DEFAULT_TIMEOUT } from '../lib/constants';\nimport RealtimeSubscription from '../RealtimeSubscription';\nexport default class Push {\n  /**\n   * Initializes the Push\n   *\n   * @param channel The Channel\n   * @param event The event, for example `\"phx_join\"`\n   * @param payload The payload, for example `{user_id: 123}`\n   * @param timeout The push timeout in milliseconds\n   */\n  constructor(channel, event) {\n    let payload = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n    let timeout = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : DEFAULT_TIMEOUT;\n    this.channel = channel;\n    this.event = event;\n    this.payload = payload;\n    this.timeout = timeout;\n    this.sent = false;\n    this.timeoutTimer = undefined;\n    this.ref = '';\n    this.receivedResp = null;\n    this.recHooks = [];\n    this.refEvent = null;\n  }\n  resend(timeout) {\n    this.timeout = timeout;\n    this._cancelRefEvent();\n    this.ref = '';\n    this.refEvent = null;\n    this.receivedResp = null;\n    this.sent = false;\n    this.send();\n  }\n  send() {\n    if (this._hasReceived('timeout')) {\n      return;\n    }\n    this.startTimeout();\n    this.sent = true;\n    this.channel.socket.push({\n      topic: this.channel.topic,\n      event: this.event,\n      payload: this.payload,\n      ref: this.ref\n    });\n  }\n  updatePayload(payload) {\n    this.payload = Object.assign(Object.assign({}, this.payload), payload);\n  }\n  receive(status, callback) {\n    var _a;\n    if (this._hasReceived(status)) {\n      callback((_a = this.receivedResp) === null || _a === void 0 ? void 0 : _a.response);\n    }\n    this.recHooks.push({\n      status,\n      callback\n    });\n    return this;\n  }\n  startTimeout() {\n    if (this.timeoutTimer) {\n      return;\n    }\n    this.ref = this.channel.socket.makeRef();\n    this.refEvent = this.channel.replyEventName(this.ref);\n    const callback = payload => {\n      this._cancelRefEvent();\n      this._cancelTimeout();\n      this.receivedResp = payload;\n      this._matchReceive(payload);\n    };\n    if (this.channel instanceof RealtimeSubscription) {\n      this.channel.on(this.refEvent, callback);\n    } else {\n      this.channel.on(this.refEvent, {}, callback);\n    }\n    this.timeoutTimer = setTimeout(() => {\n      this.trigger('timeout', {});\n    }, this.timeout);\n  }\n  trigger(status, response) {\n    if (this.refEvent) this.channel.trigger(this.refEvent, {\n      status,\n      response\n    });\n  }\n  destroy() {\n    this._cancelRefEvent();\n    this._cancelTimeout();\n  }\n  _cancelRefEvent() {\n    if (!this.refEvent) {\n      return;\n    }\n    if (this.channel instanceof RealtimeSubscription) {\n      this.channel.off(this.refEvent);\n    } else {\n      this.channel.off(this.refEvent, {});\n    }\n  }\n  _cancelTimeout() {\n    clearTimeout(this.timeoutTimer);\n    this.timeoutTimer = undefined;\n  }\n  _matchReceive(_ref) {\n    let {\n      status,\n      response\n    } = _ref;\n    this.recHooks.filter(h => h.status === status).forEach(h => h.callback(response));\n  }\n  _hasReceived(status) {\n    return this.receivedResp && this.receivedResp.status === status;\n  }\n}","map":{"version":3,"names":["DEFAULT_TIMEOUT","RealtimeSubscription","Push","constructor","channel","event","payload","arguments","length","undefined","timeout","sent","timeoutTimer","ref","receivedResp","recHooks","refEvent","resend","_cancelRefEvent","send","_hasReceived","startTimeout","socket","push","topic","updatePayload","Object","assign","receive","status","callback","_a","response","makeRef","replyEventName","_cancelTimeout","_matchReceive","on","setTimeout","trigger","destroy","off","clearTimeout","_ref","filter","h","forEach"],"sources":["/Users/mako/Downloads/supabase-todo-main/node_modules/@supabase/realtime-js/src/lib/push.ts"],"sourcesContent":["import { DEFAULT_TIMEOUT } from '../lib/constants'\nimport RealtimeChannel from '../RealtimeChannel'\nimport RealtimeSubscription from '../RealtimeSubscription'\n\nexport default class Push {\n  sent: boolean = false\n  timeoutTimer: number | undefined = undefined\n  ref: string = ''\n  receivedResp: {\n    status: string\n    response: Function\n  } | null = null\n  recHooks: {\n    status: string\n    callback: Function\n  }[] = []\n  refEvent: string | null = null\n\n  /**\n   * Initializes the Push\n   *\n   * @param channel The Channel\n   * @param event The event, for example `\"phx_join\"`\n   * @param payload The payload, for example `{user_id: 123}`\n   * @param timeout The push timeout in milliseconds\n   */\n  constructor(\n    public channel: RealtimeSubscription | RealtimeChannel,\n    public event: string,\n    public payload: { [key: string]: unknown } = {},\n    public timeout: number = DEFAULT_TIMEOUT\n  ) {}\n\n  resend(timeout: number) {\n    this.timeout = timeout\n    this._cancelRefEvent()\n    this.ref = ''\n    this.refEvent = null\n    this.receivedResp = null\n    this.sent = false\n    this.send()\n  }\n\n  send() {\n    if (this._hasReceived('timeout')) {\n      return\n    }\n    this.startTimeout()\n    this.sent = true\n    this.channel.socket.push({\n      topic: this.channel.topic,\n      event: this.event,\n      payload: this.payload,\n      ref: this.ref,\n    })\n  }\n\n  updatePayload(payload: { [key: string]: unknown }): void {\n    this.payload = { ...this.payload, ...payload }\n  }\n\n  receive(status: string, callback: Function) {\n    if (this._hasReceived(status)) {\n      callback(this.receivedResp?.response)\n    }\n\n    this.recHooks.push({ status, callback })\n    return this\n  }\n\n  startTimeout() {\n    if (this.timeoutTimer) {\n      return\n    }\n    this.ref = this.channel.socket.makeRef()\n    this.refEvent = this.channel.replyEventName(this.ref)\n\n    const callback = (payload: any) => {\n      this._cancelRefEvent()\n      this._cancelTimeout()\n      this.receivedResp = payload\n      this._matchReceive(payload)\n    }\n\n    if (this.channel instanceof RealtimeSubscription) {\n      this.channel.on(this.refEvent, callback)\n    } else {\n      this.channel.on(this.refEvent, {}, callback)\n    }\n\n    this.timeoutTimer = <any>setTimeout(() => {\n      this.trigger('timeout', {})\n    }, this.timeout)\n  }\n\n  trigger(status: string, response: any) {\n    if (this.refEvent) this.channel.trigger(this.refEvent, { status, response })\n  }\n\n  destroy() {\n    this._cancelRefEvent()\n    this._cancelTimeout()\n  }\n\n  private _cancelRefEvent() {\n    if (!this.refEvent) {\n      return\n    }\n\n    if (this.channel instanceof RealtimeSubscription) {\n      this.channel.off(this.refEvent)\n    } else {\n      this.channel.off(this.refEvent, {})\n    }\n  }\n\n  private _cancelTimeout() {\n    clearTimeout(this.timeoutTimer)\n    this.timeoutTimer = undefined\n  }\n\n  private _matchReceive({\n    status,\n    response,\n  }: {\n    status: string\n    response: Function\n  }) {\n    this.recHooks\n      .filter((h) => h.status === status)\n      .forEach((h) => h.callback(response))\n  }\n\n  private _hasReceived(status: string) {\n    return this.receivedResp && this.receivedResp.status === status\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}